{
  "kpis": ["RevPAR", "ADR", "Occupancy Rate", "RevPAR Trend"],
  "python_code": "import pandas as pd\nimport numpy as np\nfrom pathlib import Path\n\n# 데이터 로드\ndf = pd.read_csv('/Users/jungmo/Documents/data-projects/seoul_airbnb_cleaned_2026-02-18_11-23/data/raw/seoul_airbnb_cleaned.csv')\n\n# 필터링: Active + Operating 상태만\ndf_active = df[(df['refined_status'] == 'Active') & (df['operation_status'] == 'Operating')].copy()\n\nprint('='*80)\nprint('서울 에어비앤비 KPI 분석')\nprint('='*80)\nprint(f'전체 데이터: {len(df):,}개 | 활성화된 숙소: {len(df_active):,}개')\nprint('='*80)\n\n# ============================================================================\n# 1. RevPAR 분석 (TTM + L90D)\n# ============================================================================\nprint('\\n[1] RevPAR 분석')\nprint('-'*80)\n\ndef analyze_revpar(data, period_name):\n    if period_name == 'TTM':\n        revpar_col = 'ttm_revpar'\n    else:  # L90D\n        revpar_col = 'l90d_revpar'\n    \n    result = {\n        '기간': period_name,\n        '중위값': data[revpar_col].median(),\n        '평균': data[revpar_col].mean(),\n        '최소': data[revpar_col].min(),\n        '최대': data[revpar_col].max(),\n        'Q1': data[revpar_col].quantile(0.25),\n        'Q3': data[revpar_col].quantile(0.75),\n    }\n    return result\n\nrevpar_ttm_all = analyze_revpar(df, 'TTM')\nrevpar_l90d_all = analyze_revpar(df, 'L90D')\nrevpar_ttm_active = analyze_revpar(df_active, 'TTM')\nrevpar_l90d_active = analyze_revpar(df_active, 'L90D')\n\nprint('\\n전체 숙소 (TTM):')\nfor k, v in revpar_ttm_all.items():\n    if k != '기간':\n        print(f\"  {k}: {v:,.1f}\")\n\nprint('\\n활성화 숙소 (TTM):')\nfor k, v in revpar_ttm_active.items():\n    if k != '기간':\n        print(f\"  {k}: {v:,.1f}\")\n\nprint('\\n전체 숙소 (L90D):')\nfor k, v in revpar_l90d_all.items():\n    if k != '기간':\n        print(f\"  {k}: {v:,.1f}\")\n\nprint('\\n활성화 숙소 (L90D):')\nfor k, v in revpar_l90d_active.items():\n    if k != '기간':\n        print(f\"  {k}: {v:,.1f}\")\n\n# ============================================================================\n# 2. 자치구별 RevPAR 순위 (TTM)\n# ============================================================================\nprint('\\n\\n[2] 자치구별 RevPAR 순위 (TTM)')\nprint('-'*80)\n\nrevpar_by_district = df_active.groupby('district').agg({\n    'ttm_revpar': ['median', 'mean', 'count'],\n    'ttm_occupancy': 'median',\n    'ttm_avg_rate': 'median'\n}).round(1)\n\nrevpar_by_district.columns = ['RevPAR_중위', 'RevPAR_평균', '숙소수', '점유율_중위', 'ADR_중위']\nrevpar_by_district = revpar_by_district.sort_values('RevPAR_평균', ascending=False)\n\nprint('\\n순위 | 자치구          | RevPAR평균 | RevPAR중위 | 점유율 | ADR(중위) | 숙소수')\nprint('-'*80)\nfor idx, (dist, row) in enumerate(revpar_by_district.iterrows(), 1):\n    print(f'{idx:2d}  | {dist:12s} | {row[\"RevPAR_평균\"]:>9,.0f} | {row[\"RevPAR_중위\"]:>9,.0f} | {row[\"점유율_중위\"]:>5.1%} | {row[\"ADR_중위\"]:>8,.0f} | {int(row[\"숙소수\"]):>4d}')\n\n# ============================================================================\n# 3. Room Type별 RevPAR 분석\n# ============================================================================\nprint('\\n\\n[3] Room Type별 RevPAR 분석 (TTM)')\nprint('-'*80)\n\nrevpar_by_room = df_active.groupby('room_type').agg({\n    'ttm_revpar': ['median', 'mean', 'count'],\n    'ttm_occupancy': 'median',\n    'ttm_avg_rate': 'median'\n}).round(1)\n\nrevpar_by_room.columns = ['RevPAR_중위', 'RevPAR_평균', '숙소수', '점유율', 'ADR']\nrevpar_by_room = revpar_by_room.sort_values('RevPAR_평균', ascending=False)\n\nprint('\\nRoom Type      | RevPAR평균 | RevPAR중위 | 점유율 | ADR     | 숙소수')\nprint('-'*80)\nfor room_type, row in revpar_by_room.iterrows():\n    print(f'{room_type:14s} | {row[\"RevPAR_평균\"]:>9,.0f} | {row[\"RevPAR_중위\"]:>9,.0f} | {row[\"점유율\"]:>5.1%} | {row[\"ADR\"]:>7,.0f} | {int(row[\"숙소수\"]):>5d}')\n\n# ============================================================================\n# 4. Superhost 프리미엄 분석\n# ============================================================================\nprint('\\n\\n[4] Superhost 프리미엄 분석 (TTM)')\nprint('-'*80)\n\nsuperhost_analysis = df_active.groupby('superhost').agg({\n    'ttm_revpar': ['median', 'mean'],\n    'ttm_occupancy': 'median',\n    'ttm_avg_rate': 'median',\n    'district': 'count'\n}).round(1)\n\nsuperhost_analysis.columns = ['RevPAR_중위', 'RevPAR_평균', '점유율', 'ADR', '숙소수']\n\nregular_revpar = superhost_analysis.loc[False, 'RevPAR_평균']\nsuperhost_revpar = superhost_analysis.loc[True, 'RevPAR_평균']\npremium = ((superhost_revpar - regular_revpar) / regular_revpar * 100) if regular_revpar > 0 else 0\n\nprint(f'\\n일반 호스트:')\nprint(f\"  RevPAR 중위: {superhost_analysis.loc[False, 'RevPAR_중위']:,.0f}\")\nprint(f\"  RevPAR 평균: {regular_revpar:,.0f}\")\nprint(f\"  점유율: {superhost_analysis.loc[False, '점유율']:.1%}\")\nprint(f\"  ADR: {superhost_analysis.loc[False, 'ADR']:,.0f}\")\nprint(f\"  숙소수: {int(superhost_analysis.loc[False, '숙소수'])}\")\n\nprint(f'\\nSuperhost:')\nprint(f\"  RevPAR 중위: {superhost_analysis.loc[True, 'RevPAR_중위']:,.0f}\")\nprint(f\"  RevPAR 평균: {superhost_revpar:,.0f}\")\nprint(f\"  점유율: {superhost_analysis.loc[True, '점유율']:.1%}\")\nprint(f\"  ADR: {superhost_analysis.loc[True, 'ADR']:,.0f}\")\nprint(f\"  숙소수: {int(superhost_analysis.loc[True, '숙소수'])}\")\n\nprint(f'\\nSuperhost 프리미엄: {premium:+.1f}%')\n\n# ============================================================================\n# 5. Occupancy Rate 분석\n# ============================================================================\nprint('\\n\\n[5] Occupancy Rate 분석 (TTM)')\nprint('-'*80)\n\noccupancy_by_district = df_active.groupby('district')['ttm_occupancy'].agg(['median', 'mean', 'count']).round(3)\noccupancy_by_district = occupancy_by_district.sort_values('median', ascending=False)\n\nprint('\\n자치구별 점유율 (상위 10개):')\nprint('자치구          | 중위    | 평균    | 숙소수')\nprint('-'*50)\nfor dist, row in occupancy_by_district.head(10).iterrows():\n    print(f'{dist:12s} | {row[\"median\"]:>6.1%} | {row[\"mean\"]:>6.1%} | {int(row[\"count\"]):>5d}')\n\noccupancy_by_room = df_active.groupby('room_type')['ttm_occupancy'].agg(['median', 'mean']).round(3)\noccupancy_by_room = occupancy_by_room.sort_values('mean', ascending=False)\n\nprint('\\n\\nRoom Type별 점유율:')\nprint('Room Type      | 중위    | 평균')\nprint('-'*45)\nfor room_type, row in occupancy_by_room.iterrows():\n    print(f'{room_type:14s} | {row[\"median\"]:>6.1%} | {row[\"mean\"]:>6.1%}')\n\n# ============================================================================\n# 6. ADR 분석\n# ============================================================================\nprint('\\n\\n[6] ADR 분석 (TTM Average Daily Rate)')\nprint('-'*80)\n\nadr_by_district = df_active.groupby('district')['ttm_avg_rate'].agg(['median', 'mean', 'count']).round(1)\nadr_by_district = adr_by_district.sort_values('mean', ascending=False)\n\nprint('\\n자치구별 ADR (상위 10개):')\nprint('자치구          | ADR(중위)   | ADR(평균)   | 숙소수')\nprint('-'*55)\nfor dist, row in adr_by_district.head(10).iterrows():\n    print(f'{dist:12s} | {row[\"median\"]:>10,.0f} | {row[\"mean\"]:>10,.0f} | {int(row[\"count\"]):>5d}')\n\nadr_by_room = df_active.groupby('room_type')['ttm_avg_rate'].agg(['median', 'mean']).round(1)\nadr_by_room = adr_by_room.sort_values('mean', ascending=False)\n\nprint('\\n\\nRoom Type별 ADR:')\nprint('Room Type      | ADR(중위)   | ADR(평균)')\nprint('-'*50)\nfor room_type, row in adr_by_room.iterrows():\n    print(f'{room_type:14s} | {row[\"median\"]:>10,.0f} | {row[\"mean\"]:>10,.0f}')\n\n# ============================================================================\n# 7. RevPAR Trend (L90D vs TTM/4)\n# ============================================================================\nprint('\\n\\n[7] RevPAR Trend 분석 (최근 90일 vs TTM 분기 평균)')\nprint('-'*80)\n\ndf_active['ttm_quarterly_avg'] = df_active['ttm_revpar'] / 4\ndf_active['revpar_trend'] = ((df_active['l90d_revpar'] - df_active['ttm_quarterly_avg']) / df_active['ttm_quarterly_avg'] * 100).fillna(0)\ndf_active['trend_direction'] = df_active['revpar_trend'].apply(lambda x: '상승' if x > 5 else ('하락' if x < -5 else '보합'))\n\ntrend_summary = df_active['trend_direction'].value_counts()\ntrend_pct = (trend_summary / len(df_active) * 100).round(1)\n\nprint('\\n전체 추세:')\nprint(f\"  상승 (>+5%): {trend_summary.get('상승', 0):,}개 ({trend_pct.get('상승', 0):.1f}%)\")\nprint(f\"  보합: {trend_summary.get('보합', 0):,}개 ({trend_pct.get('보합', 0):.1f}%)\")\nprint(f\"  하락 (<-5%): {trend_summary.get('하락', 0):,}개 ({trend_pct.get('하락', 0):.1f}%)\")\n\nprint(f'\\n평균 RevPAR 변화율: {df_active[\"revpar_trend\"].mean():.1f}%')\nprint(f'중위 RevPAR 변화율: {df_active[\"revpar_trend\"].median():.1f}%')\n\n# 자치구별 Trend\ntrend_by_district = df_active.groupby('district').agg({\n    'revpar_trend': ['mean', 'median'],\n    'l90d_revpar': 'median',\n    'ttm_quarterly_avg': 'median',\n}).round(1)\n\ntrend_by_district.columns = ['평균_변화율', '중위_변화율', 'L90D_RevPAR', 'TTM분기평균']\ntrend_by_district = trend_by_district.sort_values('평균_변화율', ascending=False)\n\nprint('\\n\\n자치구별 RevPAR 성장률 (TTM 분기 대비 최근 90일):')\nprint('자치구          | 평균변화율 | 중위변화율 | L90D RevPAR | TTM분기평균')\nprint('-'*70)\nfor dist, row in trend_by_district.iterrows():\n    trend_icon = '▲' if row['평균_변화율'] > 0 else '▼'\n    print(f'{dist:12s} | {trend_icon} {row[\"평균_변화율\"]:>7.1f}% | {row[\"중위_변화율\"]:>8.1f}% | {row[\"L90D_RevPAR\"]:>10,.0f} | {row[\"TTM분기평균\"]:>10,.0f}')\n\n# ============================================================================\n# 결과 반환 (딕셔너리 형태)\n# ============================================================================\nprint('\\n\\n' + '='*80)\nprint('KPI 계산 완료')\nprint('='*80)\n\nkpi_results = {\n    'revpar_analysis': {\n        'ttm_all': revpar_ttm_all,\n        'ttm_active': revpar_ttm_active,\n        'l90d_all': revpar_l90d_all,\n        'l90d_active': revpar_l90d_active,\n    },\n    'revpar_by_district': revpar_by_district.to_dict(),\n    'revpar_by_room_type': revpar_by_room.to_dict(),\n    'superhost_premium': {\n        'regular_revpar': regular_revpar,\n        'superhost_revpar': superhost_revpar,\n        'premium_percent': premium,\n    },\n    'occupancy_by_district': occupancy_by_district.to_dict(),\n    'occupancy_by_room_type': occupancy_by_room.to_dict(),\n    'adr_by_district': adr_by_district.to_dict(),\n    'adr_by_room_type': adr_by_room.to_dict(),\n    'trend_summary': {\n        '상승': int(trend_summary.get('상승', 0)),\n        '보합': int(trend_summary.get('보합', 0)),\n        '하락': int(trend_summary.get('하락', 0)),\n        '평균_변화율': float(df_active['revpar_trend'].mean()),\n        '중위_변화율': float(df_active['revpar_trend'].median()),\n    },\n    'trend_by_district': trend_by_district.to_dict(),\n}\n\nprint('\\n분석 결과가 kpi_results 변수에 저장되었습니다.')"
}
