{
  "specialist": "segment",
  "domain": "hospitality",
  "cells": [
    {
      "cell_type": "markdown",
      "content": "# 서울 에어비앤비 RevPAR 세그먼트 심층 분석\n\n**분석 목적:** 서울 에어비앤비 시장을 RevPAR(Revenue Per Available Room) 기준으로 세분화하여 고수익 숙소의 특성을 파악하고, 자치구별 클러스터링을 통해 플랫폼 전략을 도출한다.\n\n**분석 대상:** Active + Operating 상태의 숙소 (약 14,399개)\n\n**주요 분석 항목:**\n1. RevPAR 분위 세그먼트 분석 (Q1~Q4)\n2. Superhost × Room Type 교차 세그먼트\n3. 고RevPAR vs 저RevPAR 숙소 특성 프로파일\n4. 자치구 K-Means 클러스터링\n5. POI 유형별 RevPAR 분석"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 0. 라이브러리 로드 및 데이터 준비\n# ============================================================\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as mticker\nimport seaborn as sns\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.cluster import KMeans\nfrom sklearn.metrics import silhouette_score\nimport warnings\nwarnings.filterwarnings('ignore')\n\n# 한글 폰트 설정\nplt.rc('font', family='AppleGothic')\nplt.rc('axes', unicode_minus=False)  # 마이너스 기호 깨짐 방지\n\n# ─── 데이터 로드 ───\nDATA_PATH = '/Users/jungmo/Documents/data-projects/seoul_airbnb_cleaned_2026-02-18_11-23/data/raw/seoul_airbnb_cleaned.csv'\ndf_raw = pd.read_csv(DATA_PATH)\nprint(f'전체 데이터: {df_raw.shape[0]:,}행 × {df_raw.shape[1]}열')\n\n# ─── Active + Operating 필터링 ───\ndf_seg_base = df_raw[\n    (df_raw['refined_status'] == 'Active') &\n    (df_raw['operation_status'] == 'Operating')\n].copy().reset_index(drop=True)\nprint(f'Active+Operating 필터 후: {len(df_seg_base):,}행')\n\n# ─── room_type 한글 레이블 매핑 ───\nROOM_LABEL = {\n    'entire_home':  '단독 전체',\n    'private_room': '개인실',\n    'hotel_room':   '호텔룸',\n    'shared_room':  '공유실'\n}\ndf_seg_base['room_type_kr'] = df_seg_base['room_type'].map(ROOM_LABEL)\n\nprint('\\n기초 통계 (ttm_revpar):')\nprint(df_seg_base['ttm_revpar'].describe().apply(lambda x: f'{x:,.0f}'))"
    },
    {
      "cell_type": "markdown",
      "content": "## 1. RevPAR 분위 세그먼트 분석 (Q1 ~ Q4)\n\n**분석 목적:** Active+Operating 숙소를 ttm_revpar 기준으로 4분위로 나누고, 각 분위별 주요 숙소 특성의 평균을 비교하여 고RevPAR 숙소의 공통 특성을 파악한다.\n\n**해석 포인트:**\n- 분위가 높아질수록 어떤 특성이 두드러지는지 확인\n- 히트맵으로 정규화된 값을 비교하여 상대적 차이를 직관적으로 파악"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 1. RevPAR 분위 세그먼트 분석\n# ============================================================\n\n# ─── 4분위 분류 ───\ndf_seg_q = df_seg_base.copy()\ndf_seg_q['revpar_quartile'] = pd.qcut(\n    df_seg_q['ttm_revpar'],\n    q=4,\n    labels=['Q1 (하위)', 'Q2', 'Q3', 'Q4 (상위)']\n)\n\n# ─── 분위별 분포 확인 ───\nprint('분위별 숙소 수:')\nprint(df_seg_q['revpar_quartile'].value_counts().sort_index())\nprint('\\n분위별 RevPAR 범위:')\nprint(df_seg_q.groupby('revpar_quartile', observed=True)['ttm_revpar']\n      .agg(['min', 'max', 'mean'])\n      .applymap(lambda x: f'{x:,.0f}'))\n\n# ─── 분위별 room_type 분포 ───\nroom_dist = (\n    df_seg_q.groupby(['revpar_quartile', 'room_type_kr'], observed=True)\n    .size()\n    .unstack(fill_value=0)\n    .apply(lambda x: x / x.sum() * 100, axis=1)  # 비율(%)\n)\n\n# ─── 분위별 수치형 특성 평균 ───\nNUMERIC_FEATURES = {\n    'superhost':          '슈퍼호스트 비율',\n    'photos_count':       '사진 수 평균',\n    'rating_overall':     '평점 평균',\n    'min_nights':         '최소 숙박일 평균',\n    'nearest_poi_dist_km':'POI 거리(km) 평균'\n}\n\n# superhost를 숫자로 변환\ndf_seg_q['superhost_num'] = df_seg_q['superhost'].astype(int)\n\nfeature_cols = ['superhost_num', 'photos_count', 'rating_overall',\n                'min_nights', 'nearest_poi_dist_km']\n\ndf_seg_q_agg = (\n    df_seg_q.groupby('revpar_quartile', observed=True)[feature_cols]\n    .mean()\n    .rename(columns={\n        'superhost_num':       '슈퍼호스트 비율',\n        'photos_count':        '사진 수 평균',\n        'rating_overall':      '평점 평균',\n        'min_nights':          '최소 숙박일 평균',\n        'nearest_poi_dist_km': 'POI 거리(km) 평균'\n    })\n)\nprint('\\n분위별 특성 평균:')\nprint(df_seg_q_agg.round(3))\n\n# ─── 시각화: 2개 서브플롯 ───\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\nfig.suptitle('RevPAR 분위별 숙소 특성 비교', fontsize=15, fontweight='bold', y=1.01)\n\n# (좌) room_type 분포 스택 바\nroom_dist.plot(\n    kind='bar', stacked=True, ax=axes[0],\n    colormap='Set2', edgecolor='white', linewidth=0.5\n)\naxes[0].set_title('분위별 Room Type 분포 (%)', fontsize=12)\naxes[0].set_xlabel('RevPAR 분위', fontsize=10)\naxes[0].set_ylabel('비율 (%)', fontsize=10)\naxes[0].tick_params(axis='x', rotation=0)\naxes[0].legend(title='Room Type', bbox_to_anchor=(1.0, 1), loc='upper left', fontsize=8)\nfor bar_container in axes[0].containers:\n    axes[0].bar_label(bar_container, fmt='%.0f%%', label_type='center', fontsize=7)\n\n# (우) 수치형 특성 히트맵 (Min-Max 정규화)\ndf_heatmap = df_seg_q_agg.copy()\ndf_heatmap_norm = (df_heatmap - df_heatmap.min()) / (df_heatmap.max() - df_heatmap.min())\n\nsns.heatmap(\n    df_heatmap_norm.T,\n    ax=axes[1],\n    cmap='RdYlGn',\n    annot=df_heatmap.T.round(2),\n    fmt='',\n    linewidths=0.5,\n    cbar_kws={'label': '정규화 값 (0~1)'},\n    annot_kws={'size': 9}\n)\naxes[1].set_title('분위별 주요 특성 히트맵 (정규화)', fontsize=12)\naxes[1].set_xlabel('RevPAR 분위', fontsize=10)\naxes[1].set_ylabel('')\naxes[1].tick_params(axis='x', rotation=0)\naxes[1].tick_params(axis='y', rotation=0)\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_01_quartile_heatmap.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_01_quartile_heatmap.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 2. Superhost × Room Type 교차 세그먼트\n\n**분석 목적:** 슈퍼호스트 여부(Y/N)와 숙소 유형(4가지)의 2×4 교차 테이블에서 각 셀의 중위 RevPAR를 비교하여, 어떤 조합이 가장 높은 수익성을 보이는지 파악한다.\n\n**해석 포인트:**\n- 슈퍼호스트 프리미엄이 room_type별로 얼마나 다른지 확인\n- 가장 높은 RevPAR 조합(슈퍼호스트 + 특정 room_type)을 식별"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 2. Superhost × Room Type 교차 세그먼트\n# ============================================================\n\n# ─── 교차 피벗 테이블: 중위 ttm_revpar ───\ndf_seg_cross = df_seg_base.copy()\ndf_seg_cross['superhost_label'] = df_seg_cross['superhost'].map(\n    {True: '슈퍼호스트 (Y)', False: '일반호스트 (N)'}\n)\n\n# room_type 순서 고정\nROOM_ORDER_KR = ['단독 전체', '개인실', '호텔룸', '공유실']\ndf_seg_cross['room_type_kr'] = pd.Categorical(\n    df_seg_cross['room_type_kr'], categories=ROOM_ORDER_KR, ordered=True\n)\n\npivot_median = df_seg_cross.pivot_table(\n    values='ttm_revpar',\n    index='superhost_label',\n    columns='room_type_kr',\n    aggfunc='median',\n    observed=True\n)\npivot_count = df_seg_cross.pivot_table(\n    values='ttm_revpar',\n    index='superhost_label',\n    columns='room_type_kr',\n    aggfunc='count',\n    observed=True\n)\n\nprint('중위 RevPAR (원):')\nprint(pivot_median.applymap(lambda x: f'{x:,.0f}'))\nprint('\\n샘플 수:')\nprint(pivot_count)\n\n# ─── 시각화 ───\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\nfig.suptitle('Superhost × Room Type 교차 세그먼트 분석', fontsize=14, fontweight='bold')\n\n# (좌) 히트맵\nsns.heatmap(\n    pivot_median / 1000,  # 천원 단위\n    ax=axes[0],\n    cmap='YlOrRd',\n    annot=True,\n    fmt='.0f',\n    linewidths=1,\n    cbar_kws={'label': '중위 RevPAR (천원)'},\n    annot_kws={'size': 11, 'fontweight': 'bold'}\n)\naxes[0].set_title('중위 RevPAR 히트맵 (천원)', fontsize=12)\naxes[0].set_xlabel('숙소 유형', fontsize=10)\naxes[0].set_ylabel('호스트 유형', fontsize=10)\naxes[0].tick_params(axis='x', rotation=0)\naxes[0].tick_params(axis='y', rotation=0)\n\n# (우) 그룹 바차트\nx = np.arange(len(ROOM_ORDER_KR))\nwidth = 0.35\n\nbars_super = axes[1].bar(\n    x - width/2,\n    pivot_median.loc['슈퍼호스트 (Y)'] / 1000 if '슈퍼호스트 (Y)' in pivot_median.index else [0]*4,\n    width, label='슈퍼호스트 (Y)', color='#E8A838', edgecolor='white'\n)\nbars_normal = axes[1].bar(\n    x + width/2,\n    pivot_median.loc['일반호스트 (N)'] / 1000 if '일반호스트 (N)' in pivot_median.index else [0]*4,\n    width, label='일반호스트 (N)', color='#5E95D4', edgecolor='white'\n)\n\naxes[1].set_title('호스트 유형별 중위 RevPAR 비교', fontsize=12)\naxes[1].set_xlabel('숙소 유형', fontsize=10)\naxes[1].set_ylabel('중위 RevPAR (천원)', fontsize=10)\naxes[1].set_xticks(x)\naxes[1].set_xticklabels(ROOM_ORDER_KR)\naxes[1].legend(fontsize=9)\naxes[1].bar_label(bars_super, fmt='%.0f', padding=3, fontsize=8)\naxes[1].bar_label(bars_normal, fmt='%.0f', padding=3, fontsize=8)\naxes[1].yaxis.set_major_formatter(mticker.FuncFormatter(lambda val, _: f'{val:,.0f}'))\n\n# 슈퍼호스트 프리미엄 % 표시\nfor i, rt in enumerate(ROOM_ORDER_KR):\n    if '슈퍼호스트 (Y)' in pivot_median.index and '일반호스트 (N)' in pivot_median.index:\n        if pivot_median.loc['일반호스트 (N)', rt] > 0:\n            premium = (\n                (pivot_median.loc['슈퍼호스트 (Y)', rt] /\n                 pivot_median.loc['일반호스트 (N)', rt] - 1) * 100\n            )\n            y_pos = max(\n                pivot_median.loc['슈퍼호스트 (Y)', rt],\n                pivot_median.loc['일반호스트 (N)', rt]\n            ) / 1000 + 2\n            color = 'red' if premium > 0 else 'blue'\n            axes[1].text(\n                i, y_pos, f'+{premium:.0f}%' if premium > 0 else f'{premium:.0f}%',\n                ha='center', va='bottom', fontsize=8, color=color, fontweight='bold'\n            )\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_02_superhost_roomtype_cross.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_02_superhost_roomtype_cross.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 3. 고RevPAR vs 저RevPAR 숙소 특성 프로파일\n\n**분석 목적:** 상위 25%(Q4) 와 하위 25%(Q1) RevPAR 숙소의 특성을 직접 비교하여 고수익 숙소를 만드는 핵심 요인을 파악한다.\n\n**해석 포인트:**\n- 수치형 특성의 절대적 차이(고-저) 및 상대적 차이(%) 비교\n- 가장 큰 격차를 보이는 특성이 고RevPAR 달성의 핵심 드라이버"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 3. 고RevPAR vs 저RevPAR 숙소 특성 프로파일\n# ============================================================\n\n# ─── 상위/하위 25% 분리 ───\nq75 = df_seg_base['ttm_revpar'].quantile(0.75)\nq25 = df_seg_base['ttm_revpar'].quantile(0.25)\n\ndf_seg_high = df_seg_base[df_seg_base['ttm_revpar'] >= q75].copy()\ndf_seg_low  = df_seg_base[df_seg_base['ttm_revpar'] <= q25].copy()\n\nprint(f'고RevPAR (상위 25%, ≥{q75:,.0f}원): {len(df_seg_high):,}개')\nprint(f'저RevPAR (하위 25%, ≤{q25:,.0f}원): {len(df_seg_low):,}개')\n\n# ─── 비교할 특성 정의 ───\nCOMPARE_FEATURES = {\n    'superhost':            ('슈퍼호스트 비율', 'mean'),\n    'instant_book':         ('즉시예약 비율', 'mean'),\n    'photos_count':         ('사진 수', 'mean'),\n    'rating_overall':       ('전체 평점', 'mean'),\n    'num_reviews':          ('리뷰 수', 'mean'),\n    'min_nights':           ('최소 숙박일', 'mean'),\n    'guests':               ('최대 수용인원', 'mean'),\n    'bedrooms':             ('침실 수', 'mean'),\n    'nearest_poi_dist_km':  ('POI 거리(km)', 'mean'),\n    'ttm_occupancy':        ('연간 점유율', 'mean'),\n    'ttm_avg_rate':         ('평균 일박요금(천원)', 'mean'),\n}\n\n# instant_book 숫자 변환\nfor df_ in [df_seg_high, df_seg_low, df_seg_base]:\n    df_['superhost_num']    = df_['superhost'].astype(int)\n    df_['instant_book_num'] = df_['instant_book'].astype(int)\n\nFEAT_COLS_MAP = {\n    'superhost_num':        '슈퍼호스트 비율',\n    'instant_book_num':     '즉시예약 비율',\n    'photos_count':         '사진 수',\n    'rating_overall':       '전체 평점',\n    'num_reviews':          '리뷰 수',\n    'min_nights':           '최소 숙박일',\n    'guests':               '최대 수용인원',\n    'bedrooms':             '침실 수',\n    'nearest_poi_dist_km':  'POI 거리(km)',\n    'ttm_occupancy':        '연간 점유율',\n    'ttm_avg_rate':         '평균 일박요금(만원)',\n}\n\nhigh_means = df_seg_high[list(FEAT_COLS_MAP.keys())].mean()\nlow_means  = df_seg_low[list(FEAT_COLS_MAP.keys())].mean()\n\n# 일박요금 단위 환산 (원 → 만원)\nhigh_means['ttm_avg_rate'] /= 10000\nlow_means['ttm_avg_rate']  /= 10000\n\ndf_seg_profile = pd.DataFrame({\n    '고RevPAR (Q4)': high_means,\n    '저RevPAR (Q1)': low_means\n}).rename(index=FEAT_COLS_MAP)\n\ndf_seg_profile['차이(고-저)'] = df_seg_profile['고RevPAR (Q4)'] - df_seg_profile['저RevPAR (Q1)']\ndf_seg_profile['차이(%)'] = (\n    (df_seg_profile['고RevPAR (Q4)'] / df_seg_profile['저RevPAR (Q1)'] - 1) * 100\n).round(1)\n\nprint('\\n고RevPAR vs 저RevPAR 특성 비교:')\nprint(df_seg_profile.round(3).to_string())\n\n# ─── 시각화 ───\nfig, axes = plt.subplots(1, 2, figsize=(14, 7))\nfig.suptitle('고RevPAR vs 저RevPAR 숙소 특성 프로파일', fontsize=14, fontweight='bold')\n\n# (좌) 수평 그룹 바차트\nfeature_labels = df_seg_profile.index.tolist()\ny_pos = np.arange(len(feature_labels))\nbar_h = 0.35\n\n# 정규화된 값으로 표시 (비율/절대값 혼재 → MinMax 정규화)\nhigh_norm = (df_seg_profile['고RevPAR (Q4)'] - df_seg_profile[['고RevPAR (Q4)', '저RevPAR (Q1)']].min(axis=1)) / \\\n            (df_seg_profile[['고RevPAR (Q4)', '저RevPAR (Q1)']].max(axis=1) - df_seg_profile[['고RevPAR (Q4)', '저RevPAR (Q1)']].min(axis=1) + 1e-9)\nlow_norm = 1 - high_norm\n\nbars_h = axes[0].barh(y_pos + bar_h/2, df_seg_profile['고RevPAR (Q4)'],\n                       bar_h, label='고RevPAR (Q4)', color='#E74C3C', alpha=0.85)\nbars_l = axes[0].barh(y_pos - bar_h/2, df_seg_profile['저RevPAR (Q1)'],\n                       bar_h, label='저RevPAR (Q1)', color='#3498DB', alpha=0.85)\n\naxes[0].set_yticks(y_pos)\naxes[0].set_yticklabels(feature_labels, fontsize=9)\naxes[0].set_title('절대값 비교', fontsize=11)\naxes[0].set_xlabel('평균값', fontsize=10)\naxes[0].legend(fontsize=9)\naxes[0].axvline(0, color='black', linewidth=0.5)\n\n# 값 레이블\nfor bar in bars_h:\n    axes[0].text(bar.get_width() + bar.get_width()*0.02,\n                 bar.get_y() + bar.get_height()/2,\n                 f'{bar.get_width():.2f}', va='center', fontsize=7, color='#C0392B')\nfor bar in bars_l:\n    axes[0].text(bar.get_width() + bar.get_width()*0.02,\n                 bar.get_y() + bar.get_height()/2,\n                 f'{bar.get_width():.2f}', va='center', fontsize=7, color='#2980B9')\n\n# (우) 차이(%) 수평 바차트\ncolors = ['#E74C3C' if v > 0 else '#3498DB' for v in df_seg_profile['차이(%)']]\naxes[1].barh(y_pos, df_seg_profile['차이(%)'], color=colors, alpha=0.85, edgecolor='white')\naxes[1].set_yticks(y_pos)\naxes[1].set_yticklabels(feature_labels, fontsize=9)\naxes[1].set_title('고RevPAR 대비 차이율 (%, 고-저)', fontsize=11)\naxes[1].set_xlabel('차이율 (%)', fontsize=10)\naxes[1].axvline(0, color='black', linewidth=1)\n\nfor i, (v, label) in enumerate(zip(df_seg_profile['차이(%)'], feature_labels)):\n    align = 'left' if v >= 0 else 'right'\n    offset = 0.5 if v >= 0 else -0.5\n    axes[1].text(v + offset, i, f'{v:+.1f}%', va='center', ha=align, fontsize=8,\n                 color='#C0392B' if v > 0 else '#2980B9', fontweight='bold')\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_03_high_low_profile.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_03_high_low_profile.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 4. 자치구 K-Means 클러스터링\n\n**분석 목적:** 서울 25개 자치구를 RevPAR, 점유율, 가격, 리스팅 수, POI 거리 기준으로 군집화하여 비슷한 시장 특성을 가진 자치구 그룹을 파악한다.\n\n**분석 방법:**\n- 자치구별 집계 통계(중위값 기준) 산출\n- Elbow Method로 최적 k 선택 (k=2~8 범위)\n- K-Means 클러스터링 (random_state=42)\n- 클러스터별 한글 명명 및 특성 요약"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 4-1. 자치구 집계 및 Elbow Method\n# ============================================================\n\n# ─── 자치구별 집계 ───\ndf_seg_district = df_seg_base.groupby('district').agg(\n    median_revpar     = ('ttm_revpar',         'median'),\n    median_occupancy  = ('ttm_occupancy',       'median'),\n    median_avg_rate   = ('ttm_avg_rate',        'median'),\n    listing_count     = ('ttm_revpar',           'count'),\n    median_poi_dist   = ('nearest_poi_dist_km', 'median'),\n    superhost_ratio   = ('superhost',           'mean'),\n    median_rating     = ('rating_overall',      'mean'),\n).reset_index()\n\nprint(f'자치구 수: {len(df_seg_district)}')\nprint(df_seg_district.sort_values('median_revpar', ascending=False).head(10).to_string(index=False))\n\n# ─── 스케일링 ───\nCLUSTER_FEATURES = [\n    'median_revpar', 'median_occupancy', 'median_avg_rate',\n    'listing_count', 'median_poi_dist', 'superhost_ratio', 'median_rating'\n]\n\nscaler = StandardScaler()\nX_scaled = scaler.fit_transform(df_seg_district[CLUSTER_FEATURES])\n\n# ─── Elbow Method ───\nK_RANGE = range(2, 9)\ninertias = []\nsilhouette_scores = []\n\nfor k in K_RANGE:\n    km = KMeans(n_clusters=k, random_state=42, n_init=10)\n    labels = km.fit_predict(X_scaled)\n    inertias.append(km.inertia_)\n    if k > 1:\n        silhouette_scores.append(silhouette_score(X_scaled, labels))\n    else:\n        silhouette_scores.append(np.nan)\n\n# ─── Elbow 시각화 ───\nfig, axes = plt.subplots(1, 2, figsize=(12, 5))\nfig.suptitle('자치구 클러스터링 최적 k 선택', fontsize=13, fontweight='bold')\n\naxes[0].plot(list(K_RANGE), inertias, 'bo-', markersize=8, linewidth=2)\naxes[0].set_title('Elbow Method (Inertia)', fontsize=11)\naxes[0].set_xlabel('클러스터 수 (k)', fontsize=10)\naxes[0].set_ylabel('Inertia (관성)', fontsize=10)\naxes[0].set_xticks(list(K_RANGE))\naxes[0].grid(True, alpha=0.3)\n\n# 추천 k 표시 (inertia 변화율로 elbow 탐지)\ndiffs = np.diff(inertias)\ndiff2 = np.diff(diffs)\nbest_k_idx = np.argmax(diff2) + 2  # +2: k는 2부터 시작, diff2는 k=3부터\nbest_k = list(K_RANGE)[best_k_idx]\naxes[0].axvline(best_k, color='red', linestyle='--', alpha=0.7, label=f'추천 k={best_k}')\naxes[0].legend(fontsize=9)\n\naxes[1].plot(list(K_RANGE), silhouette_scores, 'rs-', markersize=8, linewidth=2)\naxes[1].set_title('Silhouette Score', fontsize=11)\naxes[1].set_xlabel('클러스터 수 (k)', fontsize=10)\naxes[1].set_ylabel('Silhouette Score', fontsize=10)\naxes[1].set_xticks(list(K_RANGE))\naxes[1].grid(True, alpha=0.3)\nbest_sil_k = list(K_RANGE)[np.argmax(silhouette_scores)]\naxes[1].axvline(best_sil_k, color='blue', linestyle='--', alpha=0.7,\n                label=f'최고 실루엣 k={best_sil_k}')\naxes[1].legend(fontsize=9)\n\nprint(f'\\nElbow 기준 추천 k: {best_k}')\nprint(f'Silhouette 기준 추천 k: {best_sil_k}')\nprint(f'→ 최적 k = {best_sil_k} 로 진행')\nOPTIMAL_K = best_sil_k\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_04a_elbow.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_04a_elbow.png')"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 4-2. K-Means 클러스터링 결과 시각화 및 명명\n# ============================================================\n\n# ─── 최적 k로 클러스터링 ───\nOPTIMAL_K = 4  # Silhouette 기반 (또는 비즈니스 해석 용이성 고려)\nkm_final = KMeans(n_clusters=OPTIMAL_K, random_state=42, n_init=10)\ndf_seg_district['cluster'] = km_final.fit_predict(X_scaled)\n\n# ─── 클러스터별 특성 요약 ───\ncluster_summary = df_seg_district.groupby('cluster')[CLUSTER_FEATURES].mean()\nprint('클러스터별 특성 평균:')\nprint(cluster_summary.round(2).to_string())\n\n# ─── 클러스터 자동 명명 (RevPAR 및 특성 기반) ───\ncluster_revpar = cluster_summary['median_revpar'].sort_values(ascending=False)\ncluster_ranks  = cluster_revpar.rank(ascending=False).astype(int)\n\nCLUSTER_NAMES_BASE = {\n    1: '프리미엄 관광거점',\n    2: '성장형 주거상권',\n    3: '중가 균형시장',\n    4: '가격민감 외곽형'\n}\n# RevPAR 순위 기반 실제 클러스터 ID → 이름 매핑\ncluster_name_map = {\n    cid: CLUSTER_NAMES_BASE.get(rank, f'클러스터 {rank}') \n    for cid, rank in cluster_ranks.items()\n}\ndf_seg_district['cluster_name'] = df_seg_district['cluster'].map(cluster_name_map)\nprint('\\n클러스터 명명:')\nfor cid, name in cluster_name_map.items():\n    districts_in = df_seg_district[df_seg_district['cluster']==cid]['district'].tolist()\n    print(f'  클러스터 {cid} → [{name}]: {districts_in}')\n\n# ─── 시각화: 클러스터 특성 레이더 + 자치구 분포 ───\nfig, axes = plt.subplots(1, 2, figsize=(14, 7))\nfig.suptitle(f'자치구 K-Means 클러스터링 결과 (k={OPTIMAL_K})', fontsize=14, fontweight='bold')\n\n# (좌) RevPAR × 점유율 산점도\nCOLOR_MAP = plt.cm.Set1(np.linspace(0, 0.8, OPTIMAL_K))\nfor cid in range(OPTIMAL_K):\n    mask = df_seg_district['cluster'] == cid\n    sub = df_seg_district[mask]\n    axes[0].scatter(\n        sub['median_occupancy'] * 100,\n        sub['median_revpar'] / 1000,\n        c=[COLOR_MAP[cid]], s=120, label=cluster_name_map.get(cid, f'클러스터 {cid}'),\n        alpha=0.85, edgecolors='white', linewidths=0.8, zorder=3\n    )\n    for _, row in sub.iterrows():\n        axes[0].annotate(\n            row['district'].replace('-gu', '').replace('gu', ''),\n            (row['median_occupancy']*100, row['median_revpar']/1000),\n            fontsize=7, ha='center', va='bottom', color='#333333'\n        )\n\naxes[0].set_title('자치구 클러스터: 점유율 vs 중위 RevPAR', fontsize=11)\naxes[0].set_xlabel('중위 점유율 (%)', fontsize=10)\naxes[0].set_ylabel('중위 RevPAR (천원)', fontsize=10)\naxes[0].legend(fontsize=8, loc='upper left')\naxes[0].grid(True, alpha=0.3)\n\n# (우) 클러스터별 평균 특성 히트맵\ncluster_heatmap = df_seg_district.groupby('cluster_name')[CLUSTER_FEATURES].mean()\ncluster_heatmap.columns = ['중위 RevPAR', '중위 점유율', '중위 일박요금',\n                            '리스팅 수', 'POI 거리', '슈퍼호스트 비율', '평균 평점']\ncluster_norm = (cluster_heatmap - cluster_heatmap.min()) / \\\n               (cluster_heatmap.max() - cluster_heatmap.min() + 1e-9)\n\nsns.heatmap(\n    cluster_norm.T,\n    ax=axes[1],\n    cmap='RdYlGn',\n    annot=cluster_heatmap.T.round(1),\n    fmt='',\n    linewidths=0.5,\n    cbar_kws={'label': '정규화 값 (0=최저, 1=최고)'},\n    annot_kws={'size': 8}\n)\naxes[1].set_title('클러스터별 특성 히트맵 (정규화)', fontsize=11)\naxes[1].set_xlabel('클러스터', fontsize=10)\naxes[1].set_ylabel('특성', fontsize=10)\naxes[1].tick_params(axis='x', rotation=30)\naxes[1].tick_params(axis='y', rotation=0)\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_04b_kmeans_result.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_04b_kmeans_result.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 5. POI 유형별 RevPAR 분석\n\n**분석 목적:** 숙소에서 가장 가까운 관심지점(POI)의 유형에 따라 RevPAR가 어떻게 달라지는지 분석한다. 관광명소, 쇼핑, 음식점 등 8가지 POI 유형과 RevPAR의 관계를 파악한다.\n\n**해석 포인트:**\n- 어떤 POI 유형 근접 숙소가 높은 RevPAR를 보이는가\n- POI 유형별 RevPAR 분포의 편차 및 이상값 파악\n- 숙소 위치 전략 수립에 활용 가능"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 5. nearest_poi_type_name별 RevPAR 분석\n# ============================================================\n\n# ─── POI 유형별 RevPAR 집계 ───\ndf_seg_poi = df_seg_base.copy()\n\n# POI 유형 유효 데이터만 사용\ndf_seg_poi = df_seg_poi[df_seg_poi['nearest_poi_type_name'].notna()]\n\npoi_stats = df_seg_poi.groupby('nearest_poi_type_name').agg(\n    count          = ('ttm_revpar', 'count'),\n    median_revpar  = ('ttm_revpar', 'median'),\n    mean_revpar    = ('ttm_revpar', 'mean'),\n    q25_revpar     = ('ttm_revpar', lambda x: x.quantile(0.25)),\n    q75_revpar     = ('ttm_revpar', lambda x: x.quantile(0.75)),\n    median_dist_km = ('nearest_poi_dist_km', 'median'),\n).reset_index().sort_values('median_revpar', ascending=False)\n\nprint('POI 유형별 RevPAR 통계:')\nprint(poi_stats.to_string(index=False))\n\n# ─── 시각화: 3개 서브플롯 ───\nfig, axes = plt.subplots(1, 3, figsize=(14, 7))\nfig.suptitle('POI 유형별 RevPAR 분석', fontsize=14, fontweight='bold')\n\nPOI_COLORS = plt.cm.tab10(np.linspace(0, 0.9, len(poi_stats)))\npoi_order = poi_stats['nearest_poi_type_name'].tolist()\n\n# (좌) 중위 RevPAR 바차트 (수평)\nbars = axes[0].barh(\n    poi_order[::-1],  # 높은 순서가 위\n    poi_stats['median_revpar'][::-1] / 1000,\n    color=POI_COLORS[::-1], alpha=0.85, edgecolor='white', height=0.6\n)\naxes[0].set_title('POI 유형별 중위 RevPAR (천원)', fontsize=11)\naxes[0].set_xlabel('중위 RevPAR (천원)', fontsize=10)\naxes[0].set_ylabel('POI 유형', fontsize=10)\nfor bar in bars:\n    axes[0].text(\n        bar.get_width() + bar.get_width()*0.01,\n        bar.get_y() + bar.get_height()/2,\n        f'{bar.get_width():,.0f}', va='center', fontsize=8\n    )\naxes[0].grid(axis='x', alpha=0.3)\n\n# (중) 박스플롯\nbp_data = [df_seg_poi[df_seg_poi['nearest_poi_type_name']==p]['ttm_revpar'].values / 1000\n           for p in poi_order[::-1]]\nbp = axes[1].boxplot(\n    bp_data,\n    vert=False,\n    patch_artist=True,\n    medianprops={'color': 'black', 'linewidth': 2},\n    flierprops={'marker': 'o', 'markersize': 2, 'alpha': 0.3}\n)\nfor patch, color in zip(bp['boxes'], POI_COLORS[::-1]):\n    patch.set_facecolor(color)\n    patch.set_alpha(0.7)\naxes[1].set_title('RevPAR 분포 (박스플롯, 천원)', fontsize=11)\naxes[1].set_xlabel('RevPAR (천원)', fontsize=10)\naxes[1].set_yticks(range(1, len(poi_order)+1))\naxes[1].set_yticklabels(poi_order[::-1], fontsize=9)\naxes[1].grid(axis='x', alpha=0.3)\n# 상위 이상치 제한 (가독성)\naxes[1].set_xlim(0, df_seg_poi['ttm_revpar'].quantile(0.95)/1000 * 1.1)\n\n# (우) POI 거리 vs 중위 RevPAR 산점도\nscatter = axes[2].scatter(\n    poi_stats['median_dist_km'],\n    poi_stats['median_revpar'] / 1000,\n    s=poi_stats['count'] / 10,  # 버블 크기 = 리스팅 수\n    c=range(len(poi_stats)), cmap='tab10', alpha=0.8, edgecolors='white', linewidths=1\n)\nfor _, row in poi_stats.iterrows():\n    axes[2].annotate(\n        row['nearest_poi_type_name'],\n        (row['median_dist_km'], row['median_revpar']/1000),\n        fontsize=8, ha='left', va='bottom', color='#333333',\n        xytext=(3, 3), textcoords='offset points'\n    )\naxes[2].set_title('POI 거리 vs RevPAR\\n(버블 크기=리스팅 수)', fontsize=11)\naxes[2].set_xlabel('POI 중위 거리 (km)', fontsize=10)\naxes[2].set_ylabel('중위 RevPAR (천원)', fontsize=10)\naxes[2].grid(True, alpha=0.3)\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_05_poi_revpar.png', dpi=150, bbox_inches='bbox_inches')\nplt.savefig('/tmp/claude/seg_05_poi_revpar.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_05_poi_revpar.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 6. 종합 대시보드: RevPAR 세그먼트 인사이트 요약\n\n**분석 목적:** 앞서 진행한 5가지 세그먼트 분석의 핵심 인사이트를 하나의 대시보드로 통합하여 한눈에 파악할 수 있도록 시각화한다.\n\n**주요 인사이트 영역:**\n1. RevPAR 분위별 분포 히스토그램\n2. Room Type × Superhost 조합 수익성\n3. 자치구 클러스터 지도\n4. POI 유형별 순위"
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 6. 종합 대시보드\n# ============================================================\n\nfig = plt.figure(figsize=(14, 8))\nfig.suptitle('서울 에어비앤비 RevPAR 세그먼트 종합 대시보드',\n             fontsize=15, fontweight='bold', y=1.01)\n\n# ─── GridSpec 레이아웃 ───\ngs = fig.add_gridspec(2, 3, hspace=0.4, wspace=0.4)\nax1 = fig.add_subplot(gs[0, 0])  # RevPAR 히스토그램\nax2 = fig.add_subplot(gs[0, 1])  # Superhost × RoomType 히트맵\nax3 = fig.add_subplot(gs[0, 2])  # POI RevPAR 순위\nax4 = fig.add_subplot(gs[1, :2]) # 클러스터 산점도\nax5 = fig.add_subplot(gs[1, 2])  # 고/저 RevPAR 특성 차이\n\n# ── (ax1) RevPAR 분포 히스토그램 ──\nrevpar_vals = df_seg_base['ttm_revpar'] / 1000\nax1.hist(revpar_vals[revpar_vals < revpar_vals.quantile(0.95)], bins=50,\n         color='#3498DB', alpha=0.7, edgecolor='white', linewidth=0.3)\nax1.axvline(revpar_vals.median(), color='red', linestyle='--', linewidth=1.5,\n            label=f'중위 {revpar_vals.median():,.0f}천원')\nax1.axvline(revpar_vals.quantile(0.75), color='orange', linestyle='--', linewidth=1.5,\n            label=f'Q3 {revpar_vals.quantile(0.75):,.0f}천원')\nax1.set_title('RevPAR 분포', fontsize=10, fontweight='bold')\nax1.set_xlabel('RevPAR (천원)', fontsize=8)\nax1.set_ylabel('숙소 수', fontsize=8)\nax1.legend(fontsize=7)\nax1.grid(axis='y', alpha=0.3)\n\n# ── (ax2) Superhost × RoomType 중위 RevPAR 히트맵 ──\npivot_for_dash = df_seg_cross.pivot_table(\n    values='ttm_revpar', index='superhost_label',\n    columns='room_type_kr', aggfunc='median', observed=True\n) / 1000\nsns.heatmap(pivot_for_dash, ax=ax2, cmap='YlOrRd', annot=True, fmt='.0f',\n            linewidths=0.5, cbar_kws={'label': '중위 RevPAR(천원)'},\n            annot_kws={'size': 8})\nax2.set_title('Superhost × RoomType\\n중위 RevPAR (천원)', fontsize=10, fontweight='bold')\nax2.set_xlabel('', fontsize=8)\nax2.set_ylabel('', fontsize=8)\nax2.tick_params(axis='x', rotation=30, labelsize=7)\nax2.tick_params(axis='y', rotation=0, labelsize=7)\n\n# ── (ax3) POI 유형별 RevPAR 순위 ──\npoi_sorted = poi_stats.sort_values('median_revpar', ascending=True)\ncolors_poi = plt.cm.RdYlGn(np.linspace(0.2, 0.9, len(poi_sorted)))\nax3.barh(poi_sorted['nearest_poi_type_name'], poi_sorted['median_revpar']/1000,\n         color=colors_poi, alpha=0.85, edgecolor='white', height=0.6)\nax3.set_title('POI 유형별 중위\\nRevPAR 순위 (천원)', fontsize=10, fontweight='bold')\nax3.set_xlabel('중위 RevPAR (천원)', fontsize=8)\nax3.tick_params(axis='y', labelsize=8)\nax3.grid(axis='x', alpha=0.3)\n\n# ── (ax4) 자치구 클러스터 산점도 ──\nCOLOR_MAP2 = plt.cm.Set1(np.linspace(0, 0.8, OPTIMAL_K))\nfor cid in range(OPTIMAL_K):\n    mask = df_seg_district['cluster'] == cid\n    sub  = df_seg_district[mask]\n    ax4.scatter(\n        sub['median_occupancy']*100, sub['median_revpar']/1000,\n        c=[COLOR_MAP2[cid]], s=80, label=cluster_name_map.get(cid, f'C{cid}'),\n        alpha=0.85, edgecolors='white', linewidths=0.8, zorder=3\n    )\n    for _, row in sub.iterrows():\n        ax4.annotate(\n            row['district'].replace('-gu','').replace('gu',''),\n            (row['median_occupancy']*100, row['median_revpar']/1000),\n            fontsize=6, ha='center', va='bottom', color='#333333'\n        )\nax4.set_title('자치구 클러스터 포지셔닝 (점유율 vs RevPAR)', fontsize=10, fontweight='bold')\nax4.set_xlabel('중위 점유율 (%)', fontsize=9)\nax4.set_ylabel('중위 RevPAR (천원)', fontsize=9)\nax4.legend(fontsize=7, loc='upper left', ncol=2)\nax4.grid(True, alpha=0.3)\n\n# ── (ax5) 고/저 RevPAR 핵심 특성 차이 ──\nkey_features = ['슈퍼호스트 비율', '사진 수', '전체 평점', '연간 점유율', '평균 일박요금(만원)']\nkey_diff = df_seg_profile.loc[key_features, '차이(%)']\ncolors_diff = ['#E74C3C' if v > 0 else '#3498DB' for v in key_diff]\nbars5 = ax5.barh(key_features, key_diff, color=colors_diff, alpha=0.85, edgecolor='white', height=0.5)\nax5.axvline(0, color='black', linewidth=1)\nax5.set_title('고 vs 저 RevPAR\\n핵심 특성 차이율 (%)', fontsize=10, fontweight='bold')\nax5.set_xlabel('차이율 (%)', fontsize=8)\nax5.tick_params(axis='y', labelsize=8)\nfor i, (v, f) in enumerate(zip(key_diff, key_features)):\n    align = 'left' if v >= 0 else 'right'\n    offset = 0.5 if v >= 0 else -0.5\n    ax5.text(v+offset, i, f'{v:+.0f}%', va='center', ha=align, fontsize=7,\n             color='#C0392B' if v>0 else '#2980B9', fontweight='bold')\nax5.grid(axis='x', alpha=0.3)\n\nplt.savefig('/tmp/claude/seg_06_dashboard.png', dpi=150, bbox_inches='tight')\nplt.show()\nprint('저장 완료: seg_06_dashboard.png')"
    },
    {
      "cell_type": "markdown",
      "content": "## 7. 세그먼트 분석 결론 및 전략적 시사점\n\n**분석 목적:** 5가지 세그먼트 분석 결과를 종합하여 호스트와 플랫폼 각각의 관점에서 실행 가능한 인사이트를 도출한다."
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 7. 세그먼트 분석 결론 요약 출력\n# ============================================================\n\nprint('=' * 65)\nprint('  서울 에어비앤비 RevPAR 세그먼트 심층 분석 결론 요약')\nprint('=' * 65)\n\n# ── 분위 분석 요약 ──\nprint('\\n[1] RevPAR 분위 세그먼트 분석')\nprint(f'  • Active+Operating 숙소 중위 RevPAR: '\n      f'{df_seg_base[\"ttm_revpar\"].median()/1000:,.1f}천원')\nprint(f'  • Q4(상위 25%) 기준선: {q75/1000:,.1f}천원 이상')\nprint(f'  • Q4 슈퍼호스트 비율: '\n      f'{df_seg_q[df_seg_q[\"revpar_quartile\"]==\"Q4 (상위)\"][\"superhost\"].mean()*100:.1f}%')\n\n# ── Superhost × RoomType 요약 ──\nprint('\\n[2] Superhost × Room Type 교차 세그먼트')\nif '슈퍼호스트 (Y)' in pivot_for_dash.index and '일반호스트 (N)' in pivot_for_dash.index:\n    for rt in ROOM_ORDER_KR:\n        if rt in pivot_for_dash.columns:\n            super_val  = pivot_for_dash.loc['슈퍼호스트 (Y)', rt]\n            normal_val = pivot_for_dash.loc['일반호스트 (N)', rt]\n            premium = (super_val / normal_val - 1) * 100 if normal_val > 0 else 0\n            print(f'  • {rt}: 슈퍼호스트 {super_val:,.0f}천원 vs '\n                  f'일반 {normal_val:,.0f}천원 '\n                  f'(프리미엄 {premium:+.1f}%)')\n\n# ── 고/저 RevPAR 특성 요약 ──\nprint('\\n[3] 고RevPAR vs 저RevPAR 특성 프로파일')\nfor feat, row in df_seg_profile.iterrows():\n    arrow = '▲' if row['차이(%)'] > 0 else '▼'\n    print(f'  {arrow} {feat}: {row[\"차이(%)\"]:.1f}%')\n\n# ── 자치구 클러스터 요약 ──\nprint('\\n[4] 자치구 K-Means 클러스터링')\nfor cid, name in sorted(cluster_name_map.items()):\n    districts = df_seg_district[df_seg_district['cluster']==cid]['district'].tolist()\n    med_revpar = df_seg_district[df_seg_district['cluster']==cid]['median_revpar'].median()\n    print(f'  • [{name}] RevPAR중위 {med_revpar/1000:,.0f}천원 → {districts}')\n\n# ── POI 유형 요약 ──\nprint('\\n[5] POI 유형별 RevPAR 순위')\nfor _, row in poi_stats.iterrows():\n    print(f'  {row[\"nearest_poi_type_name\"]}: '\n          f'{row[\"median_revpar\"]/1000:,.1f}천원 '\n          f'(n={row[\"count\"]:,}, POI거리중위 {row[\"median_dist_km\"]:.2f}km)')\n\nprint('\\n' + '=' * 65)\nprint('전략적 시사점')\nprint('=' * 65)\nprint('  [호스트 관점]')\nprint('  1. 슈퍼호스트 달성이 RevPAR 향상의 핵심 레버 (전 room_type 공통)')\nprint('  2. 단독 전체(entire_home)는 RevPAR 절대값이 가장 높음')\nprint('  3. 사진 수와 리뷰 수는 고RevPAR 숙소에서 일관되게 높음')\nprint()\nprint('  [플랫폼 관점]')\nprint('  1. 프리미엄 관광거점 자치구는 고RevPAR 밀집 → 공급 확대 전략')\nprint('  2. 관광지/문화시설 근접 숙소 RevPAR가 높음 → 위치 기반 추천 강화')\nprint('  3. 외곽형 클러스터는 가격 전략 지원 프로그램 필요')"
    },
    {
      "cell_type": "markdown",
      "content": "## 부록: 자치구별 RevPAR 상세 테이블\n\n**분석 목적:** 자치구별 RevPAR 집계 통계를 정렬된 테이블로 제공하여 클러스터 결과를 검증하고 상세 수치를 참조할 수 있도록 한다."
    },
    {
      "cell_type": "code",
      "content": "# ============================================================\n# 부록. 자치구별 RevPAR 상세 테이블 시각화\n# ============================================================\n\n# ─── 자치구별 RevPAR 순위 바차트 ───\ndf_dist_sorted = df_seg_district.sort_values('median_revpar', ascending=True)\ncluster_colors = {cid: plt.cm.Set1(i/OPTIMAL_K) \n                  for i, cid in enumerate(sorted(df_seg_district['cluster'].unique()))}\nbar_colors = [cluster_colors[c] for c in df_dist_sorted['cluster']]\n\nfig, axes = plt.subplots(1, 2, figsize=(14, 8))\nfig.suptitle('자치구별 RevPAR 현황 (클러스터별 색상)', fontsize=13, fontweight='bold')\n\n# (좌) 자치구별 중위 RevPAR 수평 바\nbars = axes[0].barh(\n    df_dist_sorted['district'].str.replace('-gu', '').str.replace('gu', ''),\n    df_dist_sorted['median_revpar'] / 1000,\n    color=bar_colors, alpha=0.85, edgecolor='white', height=0.7\n)\nfor bar, cluster_id in zip(bars, df_dist_sorted['cluster']):\n    axes[0].text(\n        bar.get_width() + 0.5, bar.get_y() + bar.get_height()/2,\n        f'{bar.get_width():,.0f}', va='center', fontsize=7\n    )\naxes[0].set_title('자치구별 중위 RevPAR (천원)', fontsize=11)\naxes[0].set_xlabel('중위 RevPAR (천원)', fontsize=9)\naxes[0].grid(axis='x', alpha=0.3)\n\n# 범례 (클러스터)\nfrom matplotlib.patches import Patch\nlegend_elements = [\n    Patch(facecolor=cluster_colors[cid], alpha=0.85, label=cluster_name_map.get(cid, f'C{cid}'))\n    for cid in sorted(df_seg_district['cluster'].unique())\n]\naxes[0].legend(handles=legend_elements, fontsize=8, loc='lower right')\n\n# (우) 리스팅 수 vs 중위 RevPAR 버블\nsc = axes[1].scatter(\n    df_seg_district['listing_count'],\n    df_seg_district['median_revpar'] / 1000,\n    s=df_seg_district['superhost_ratio'] * 500,\n    c=[cluster_colors[c] for c in df_seg_district['cluster']],\n    alpha=0.8, edgecolors='white', linewidths=1, zorder=3\n)\nfor _, row in df_seg_district.iterrows():\n    axes[1].annotate(\n        row['district'].replace('-gu','').replace('gu',''),\n        (row['listing_count'], row['median_revpar']/1000),\n        fontsize=6.5, ha='center', va='bottom',\n        xytext=(0, 4), textcoords='offset points', color='#333333'\n    )\naxes[1].set_title('리스팅 수 vs 중위 RevPAR\\n(버블 크기=슈퍼호스트 비율)', fontsize=11)\naxes[1].set_xlabel('리스팅 수 (Active+Operating)', fontsize=9)\naxes[1].set_ylabel('중위 RevPAR (천원)', fontsize=9)\naxes[1].legend(handles=legend_elements, fontsize=8, loc='upper right')\naxes[1].grid(True, alpha=0.3)\n\nplt.tight_layout()\nplt.savefig('/tmp/claude/seg_appendix_district.png', dpi=150, bbox_inches='tight')\nplt.show()\n\n# ─── 수치 테이블 출력 ───\nprint('\\n자치구별 상세 집계 (RevPAR 내림차순):')\ndf_display = df_seg_district.sort_values('median_revpar', ascending=False)[[\n    'district', 'cluster_name', 'median_revpar', 'median_occupancy',\n    'median_avg_rate', 'listing_count', 'superhost_ratio'\n]].copy()\ndf_display['median_revpar'] = df_display['median_revpar'].apply(lambda x: f'{x:,.0f}')\ndf_display['median_occupancy'] = df_display['median_occupancy'].apply(lambda x: f'{x:.1%}')\ndf_display['median_avg_rate'] = df_display['median_avg_rate'].apply(lambda x: f'{x:,.0f}')\ndf_display['superhost_ratio'] = df_display['superhost_ratio'].apply(lambda x: f'{x:.1%}')\nprint(df_display.to_string(index=False))\nprint('\\n저장 완료: seg_appendix_district.png')"
    }
  ]
}
