{
  "review_target": "synthesis_and_modeling.json",
  "domain": "서울 에어비앤비 RevPAR 예측",
  "review_date": "2026-02-18",
  "reviewer": "ML 모델링 코드 품질 검증 전문가 (Claude Sonnet 4.5)",
  "validation_results": {
    "1_train_test_split": {
      "status": "WARN",
      "evidence": "02_host_preprocessing.ipynb 기준: cell_num=6에서 train_test_split() 수행 후, cell_num=7에서 preprocessor.fit(X_train)을 호출하는 순서는 올바름. 그러나 cell_num=3에서 log1p 수치 변환(min_nights_log, num_reviews_log)을 split 이전 전체 df_ao에 직접 적용하는 것으로 계획됨('df_ao_transformed' 생성). 이는 train/test 동일 분포 가정하에 문제없지만, 엄밀한 의미의 data-aware 변환이 split 후 X_train 기준으로 fit되어야 한다는 원칙에 위반. TargetEncoder(district)는 ColumnTransformer 내부에서 CV fold 내 적용 예정으로 누수 방지 설계됨.",
      "fix_guidance": "cell_num=3의 log1p 수치 변환을 별도 수행하지 말고, ColumnTransformer 내 FunctionTransformer(np.log1p) 또는 Pipeline에 통합하여 fit(X_train) 시점에 일괄 처리할 것. 즉, split(cell_num=6) → preprocessor.fit(X_train) 내부에서 모든 변환이 수행되어야 함. cell_num=3~5는 탐색적 확인용으로만 사용하고 실제 변환은 파이프라인으로 일원화."
    },
    "2_data_leakage": {
      "status": "FAIL",
      "evidence": "host_perspective.features 목록에 다음 누수 위험 피처가 포함되어 있음:\n[CRITICAL] revpar_vs_district_median: 정의상 ttm_revpar / district_median_revpar이므로 타겟(ttm_revpar)의 직접 파생변수. 타겟을 알아야 계산 가능한 피처 → 제외 필수.\n[HIGH] revpar_trend: f(ttm_revpar, l90d_revpar)로 정의됨. synthesis.overall_assessment에서도 '타겟 파생 주의' 언급. 타겟 값이 계산에 직접 개입 → 제외 필수.\n[MEDIUM] price_efficiency: ttm_avg_rate / ttm_occupancy로 정의됨. ttm_avg_rate, ttm_occupancy 둘 다 exclude_features에 포함되어 있으나, 이들의 비율인 price_efficiency는 features에 포함됨. exclude_reasons에 '제외 권장'이 있으나 실제 제외되지 않음 → 제외 권장.\n[MEDIUM] district_median_revpar: 자치구별 Active+Operating RevPAR 중위값 집계. target-derived 여부 잠재적 누수. 단, 사전 집계 통계이므로 훈련 데이터 전체 기준으로 계산 후 제거하면 완화 가능하지만, 리키지 위험 명시 필요.\n반면 ttm_occupancy, ttm_avg_rate, ttm_revenue, l90d_*, revpar_percentile, log_ttm_revpar는 exclude_features에 정확히 포함됨 → 이 부분은 올바름.",
      "fix_guidance": "즉시 조치: (1) revpar_vs_district_median을 features에서 제거하고 exclude_features로 이동. (2) revpar_trend를 features에서 제거하고 exclude_features로 이동. (3) price_efficiency는 ttm_avg_rate/ttm_occupancy 파생이므로 제거 권장 (exclude_features 이동). (4) district_median_revpar는 훈련셋 내 target-derived 여부 명시하고, 사용 시 '훈련 데이터 전체 집계 → test에 join' 방식으로 수행하되 누수 위험 주석 추가. 수정 후 features 목록 재검토."
    },
    "3_log_transform": {
      "status": "PASS",
      "evidence": "modeling_strategy.host_perspective.target = 'log_ttm_revpar'. target_note: 'log1p(ttm_revpar) 사용. skewness=3.76 → log1p 변환으로 잔차 정규화'. 02_host_preprocessing cell_num=5에서 'y = np.log1p(df_ao.ttm_revpar)' 명시. 03_host_modeling cell_num=11에서 'y_pred = np.expm1(y_pred_log). y_true = np.expm1(y_test)' 역변환 명시. evaluation_notes에도 'log1p 예측값을 expm1으로 역변환 후 원 스케일 MAE·RMSE 계산' 명시됨. 수치형 피처(min_nights, num_reviews)에도 log1p 변환 계획됨.",
      "fix_guidance": "이상 없음. 다만 platform_perspective의 클러스터링에서 district_median_revpar(= Active+Operating RevPAR 중위값)을 클러스터링 피처로 사용 시 이 값도 log1p 변환 여부를 명시할 것 권장."
    },
    "4_eval_metrics": {
      "status": "PASS",
      "evidence": "evaluation_metrics = ['R2', 'MAE', 'RMSE', 'MAPE'] 명시. evaluation_notes.primary='R2', secondary='MAE'. 03_host_modeling cell_num=10에서 'cv_results = DataFrame: [Ridge, RF, LightGBM] × [R2, MAE, RMSE]'로 3모델 Train/CV 비교 계획. cell_num=11에서 test set 원 스케일(expm1 역변환 후) R2, MAE, RMSE, MAPE 계산 계획. Train vs Test 성능 비교는 cv_results(CV 성능) + test set 최종 성능 비교로 충족. MAPE도 포함됨.",
      "fix_guidance": "양호. 추가 개선 제안: DummyRegressor(baseline) 성능도 비교 테이블에 포함하면 모델의 실질적 개선량을 명확히 보여줄 수 있음. Train MAE/RMSE(과적합 확인)도 명시적으로 포함 권장."
    },
    "5_shap_analysis": {
      "status": "PASS",
      "evidence": "shap_analysis = true. shap_config.explainer = 'shap.TreeExplainer (LightGBM, RandomForest)'. plots = ['summary_plot', 'bar_plot', 'dependence_plot (top 5 features)', 'waterfall (개별 사례 3개)']. 03_host_modeling: cell_num=14(TreeExplainer, shap_values 계산), cell_num=15(summary_plot beeswarm), cell_num=16(bar_plot), cell_num=17(dependence_plot top5), cell_num=18(waterfall 고/중/저 RevPAR 3케이스), cell_num=19(호스트 액션 가이드 SHAP 통합)으로 상세 계획됨. n_samples=500으로 샘플링 계획도 적절.",
      "fix_guidance": "양호. 추가 제안: shap.summary_plot의 feature_names 파라미터에 한글 피처명 사용 시 AppleGothic 폰트 설정이 반드시 선행되어야 함(cell_num=1에서 설정 후 cell_num=15에서 적용 여부 확인 필요). force_plot(HTML 렌더링) 대신 waterfall_plot 사용은 Jupyter에서 안정적이므로 적절한 선택."
    },
    "6_font_setup": {
      "status": "WARN",
      "evidence": "00_quick_eda.ipynb cell_num=1 content_hint에 'font settings (AppleGothic), 색상 팔레트' 언급됨. 01_host_eda.ipynb cell_num=1에 'AppleGothic 폰트' 언급. 03_host_modeling cell_num=15에 'AppleGothic 폰트 주의' 언급. 그러나 어떤 셀에서도 'plt.rcParams[\"axes.unicode_minus\"] = False' 설정이 명시적으로 포함되어 있지 않음. 한글 폰트 설정만으로는 음수 기호(-) 깨짐 문제가 발생할 수 있음.",
      "fix_guidance": "모든 노트북의 상수 설정 셀(cell_num=1)에 다음 코드를 명시적으로 포함할 것:\nimport matplotlib\nmatplotlib.rc('font', family='AppleGothic')\nplt.rcParams['axes.unicode_minus'] = False\n특히 SHAP summary_plot에서 음수 SHAP 값 표시 시 이 설정이 없으면 마이너스 기호가 깨짐."
    },
    "7_cross_validation": {
      "status": "WARN",
      "evidence": "KFold(n_splits=5, shuffle=True, random_state=42) 계획 명시됨 (02_host_preprocessing cell_num=11, 03_host_modeling). 03_host_modeling에서 Ridge, RF, LightGBM 모두 cross_val_score(cv=cv)로 5-Fold CV 수행 계획. 그러나 DummyRegressor(baseline) 모델 비교 계획이 어디에도 명시되어 있지 않음. 또한 플랫폼 관점에서는 LOO-CV(LeaveOneOut) 계획이 있음(n=25 소표본 적절). 단, 호스트 관점 모델 비교 시 순진한 기준선 부재로 '모델이 얼마나 개선됐는지' 수치화 불가.",
      "fix_guidance": "03_host_modeling에 DummyRegressor(strategy='median')를 baseline으로 추가할 것:\nfrom sklearn.dummy import DummyRegressor\ndummy = DummyRegressor(strategy='median')\ndummy_cv = cross_val_score(dummy, X_train_prep, y_train, cv=cv, scoring='r2')\ncv_results 테이블에 Dummy 행 추가하여 모델 개선량 명시."
    },
    "8_domain_kpi_validity": {
      "status": "PASS",
      "evidence": "exclude_reasons에 'RevPAR = ADR × Occupancy' 공식 명시. ttm_occupancy, ttm_avg_rate 제외 근거로 이 공식 활용. synthesis의 전반에 걸쳐 RevPAR = ADR × Occupancy 구조가 일관되게 반영됨. 단위: KRW 명시(₩8,868, ₩47,850 등), 점유율 0-1 스케일 확인(ttm_occupancy_median이 클러스터링 피처로 사용). 자치구 단위 분석: 25개 자치구 Ridge LOO-CV 계획(n=25 소표본 대응). 자치구별 집계 시 count() 포함(district_agg의 [count] 집계 명시).",
      "fix_guidance": "이상 없음. 추가 제안: price_efficiency = ttm_avg_rate / ttm_occupancy 파생변수가 features에 포함된 점에서 RevPAR 공식 일관성에 모순이 발생함(ttm_avg_rate, ttm_occupancy 제외했으나 이들의 비율은 포함). 이 점을 수정하면 도메인 KPI 일관성이 완전해짐."
    },
    "9_group_analysis": {
      "status": "WARN",
      "evidence": "04_platform_eda cell_num=2에서 'district_agg = df.groupby(district).agg({ttm_revpar:[median,mean,count], ...})'로 count() 포함 집계 계획됨. dormant_ratio 계산 계획도 있음(cell_num=5). 그러나 자치구별 소표본 경고(n<10) 처리 계획이 명시되어 있지 않음. 25개 자치구의 개별 리스팅 수가 적은 구(예: 도봉구, 양천구)에서 통계 불안정성 발생 가능. 또한 01_host_eda의 groupby 분석(POI 유형, min_nights 구간 등)에서도 소표본 처리 로직이 명시되지 않음.",
      "fix_guidance": "(1) district_agg 생성 후 'n < 10인 자치구 경고 출력' 로직 추가: small_districts = district_agg[district_agg['count'] < 10]. 해당 자치구 결과 해석 시 주의 표시(별표 또는 괄호 처리). (2) POI 유형별 RevPAR 비교(H7)에서 n<30인 POI 유형 제외 또는 경고 처리. (3) 클러스터링에서 소표본 자치구(n<50 리스팅)의 집계 통계 신뢰성 경고 추가."
    },
    "10_business_logic": {
      "status": "WARN",
      "evidence": "03_host_modeling cell_num=11에서 expm1 역변환 후 원 스케일 MAE/RMSE 계산 계획됨. 그러나 예측값이 도메인 합리적 범위(₩0 ~ ₩2M) 내인지 검증하는 코드 계획이 명시되어 있지 않음. 상위 자치구 순위: synthesis에서 강동, 광진, 종로, 마포, 용산이 상위 5개구로 언급되었으나, 문제 정의에서 '종로구, 마포구, 중구'가 기준이었는데 순위 불일치 가능성이 있음. Dormant 비율 54.3%는 synthesis에서 언급되고 platform_insights(06)에서 반영 계획이 있으나, 호스트 모델 평가 시 이 맥락이 반영되지 않음.",
      "fix_guidance": "(1) 예측값 범위 검증 추가: assert (y_pred >= 0).all() and (y_pred <= 2_000_000).all(). 범위 초과 예측의 비율 출력. (2) 자치구별 예측 순위와 통계 분석(benchmark) 순위의 Spearman 상관 계산으로 순위 일관성 검증. (3) 호스트 모델 평가 시 Active+Operating 서브셋 기준임을 명시하고, Dormant를 포함한 전체 시장 대비 해석 맥락 추가."
    }
  },
  "leakage_audit": {
    "features_to_exclude": [
      "revpar_vs_district_median",
      "revpar_trend",
      "price_efficiency",
      "ttm_occupancy",
      "ttm_avg_rate",
      "ttm_revenue",
      "l90d_revpar",
      "l90d_occupancy",
      "l90d_avg_rate",
      "l90d_revenue",
      "revpar_percentile",
      "log_ttm_revpar",
      "exng",
      "ttm_exng"
    ],
    "features_confirmed_safe": [
      "room_type",
      "superhost",
      "instant_book",
      "bedrooms_group",
      "baths_group",
      "guests_group",
      "min_nights",
      "extra_guest_fee_policy",
      "rating_overall",
      "photos_count",
      "num_reviews",
      "nearest_poi_dist_km",
      "nearest_poi_type_name",
      "district",
      "photos_tier",
      "review_rate",
      "poi_dist_category",
      "district_listing_count",
      "district_superhost_rate",
      "district_operating_rate",
      "district_entire_home_rate",
      "ttm_pop"
    ],
    "features_requiring_review": [
      {
        "feature": "district_median_revpar",
        "risk_level": "MEDIUM",
        "reason": "자치구 레벨 ttm_revpar 집계 통계. 훈련 데이터 전체 기준 사전 집계 후 join하면 완화 가능하나, CV 폴드별로 재계산하지 않으면 잠재적 누수 발생. 현재 계획에 CV 내 재계산 여부 불명확.",
        "recommendation": "CV 외부에서 고정 집계값(훈련 전체 기준)으로 사용하거나, TargetEncoder처럼 fold 내부에서 계산. 또는 대안으로 district_listing_count, district_superhost_rate 등 non-target 집계만 사용 고려."
      },
      {
        "feature": "revpar_trend",
        "risk_level": "HIGH",
        "reason": "revpar_trend = (l90d_revpar - ttm_revpar/4) / (ttm_revpar/4 + eps)로 계산. ttm_revpar(타겟)이 분모 및 비교 기준으로 직접 개입. 타겟 파생 변수.",
        "recommendation": "features에서 즉시 제거. exclude_features로 이동."
      },
      {
        "feature": "revpar_vs_district_median",
        "risk_level": "CRITICAL",
        "reason": "= ttm_revpar / district_median_revpar 정의. 타겟 값 자체가 분자에 직접 포함되므로 완전한 타겟 누수.",
        "recommendation": "features에서 즉시 제거. exclude_features로 이동."
      },
      {
        "feature": "price_efficiency",
        "risk_level": "MEDIUM",
        "reason": "= ttm_avg_rate / ttm_occupancy (또는 ttm_avg_rate / (ttm_occupancy + eps)). ttm_avg_rate와 ttm_occupancy는 RevPAR의 직접 구성요소로 exclude_features에 포함됨. 이들의 비율도 동일한 정보를 간접적으로 포함함.",
        "recommendation": "features에서 제거 권장. 단, 완전한 누수보다는 높은 상관 피처로 모델 해석 왜곡 위험."
      }
    ]
  },
  "overall_status": "CONDITIONAL",
  "critical_failures": 1,
  "warnings": 5,
  "critical_failure_details": [
    "2_data_leakage: revpar_vs_district_median(타겟 직접 파생), revpar_trend(타겟 구성요소 파생)이 features 목록에 포함됨. 즉시 제거 필요."
  ],
  "warning_details": [
    "1_train_test_split: 수치 변환(log1p)이 split 이전 전체 데이터에 적용될 가능성 있음",
    "6_font_setup: plt.rcParams['axes.unicode_minus'] = False 명시적 설정 누락",
    "7_cross_validation: DummyRegressor baseline 비교 계획 없음",
    "9_group_analysis: 소표본 자치구(n<10) 경고 처리 로직 미명시",
    "10_business_logic: 예측값 도메인 범위(₩0~₩2M) 검증 로직 미포함"
  ],
  "approved_feature_list": {
    "host_perspective": [
      "room_type",
      "superhost",
      "instant_book",
      "bedrooms_group",
      "baths_group",
      "guests_group",
      "min_nights",
      "extra_guest_fee_policy",
      "rating_overall",
      "photos_count",
      "num_reviews",
      "nearest_poi_dist_km",
      "nearest_poi_type_name",
      "photos_tier",
      "review_rate",
      "poi_dist_category"
    ],
    "platform_perspective": [
      "district",
      "district_listing_count",
      "district_superhost_rate",
      "district_operating_rate",
      "district_entire_home_rate",
      "ttm_pop"
    ],
    "platform_perspective_conditional": [
      "district_median_revpar (CV 폴드별 재계산 또는 사전 고정 집계 시 조건부 허용)"
    ],
    "features_removed_by_review": [
      "revpar_vs_district_median (CRITICAL 누수 → 제거 필수)",
      "revpar_trend (HIGH 누수 → 제거 필수)",
      "price_efficiency (MEDIUM 위험 → 제거 권장)"
    ]
  },
  "recommendation": "모델링 전략은 전반적으로 체계적이고 도메인 이해도가 높으나, CONDITIONAL APPROVED 판정을 부여합니다. 실행 전 다음 수정이 반드시 선행되어야 합니다:\n\n[필수 수정 - 실행 차단]\n1. features 목록에서 revpar_vs_district_median 및 revpar_trend를 즉시 제거하고 exclude_features로 이동. 두 변수 모두 타겟(ttm_revpar)의 직접 파생이므로 모델 성능 왜곡 및 실제 배포 시 예측 불가 상황 발생.\n2. price_efficiency도 제거 권장(ttm_avg_rate / ttm_occupancy = RevPAR 구성요소 비율).\n\n[권장 수정 - 품질 개선]\n3. 모든 수치 변환을 sklearn Pipeline/ColumnTransformer에 통합하여 train/test 분리 원칙 완전 준수.\n4. 모든 노트북 상수 셀에 plt.rcParams['axes.unicode_minus'] = False 명시적 추가.\n5. DummyRegressor(strategy='median') baseline 비교 추가.\n6. 자치구별 소표본(n<10) 경고 로직 추가.\n7. 예측값 범위 검증(₩0 ~ ₩2M) 코드 추가.\n\n수정 완료 후 재검토 없이 실행 가능합니다. 전반적인 모델 아키텍처(LightGBM 주력 + Ridge baseline + RF 비교, 5-Fold CV, LOO-CV, SHAP 분석, log1p 타겟 변환)는 도메인에 적합하고 기술적으로 견고합니다."
}
